include ../.makefiles
MOD_ASSETS = $(ASSETS)/au_$(MOD)
WITH_APIS = $(shell cat ../.with-apis)
CPP_DEFINES = $(WITH_APIS) -DMC$(VER) -DTHIS_MOD=$(AUMOD)
CPP_FLAGS = -E -P $(CPP_DEFINES) -include ../../includes.h
ifdef DEBUG
	CPP_DEFINES := $(CPP_DEFINES) -DDEBUG
endif

all:
	@echo "Syntax: make <prepare|jar|clean>"

prepare:
	@mkdir -p $(SRC)/com/qzx/au/$(MOD)
	@(cd src; for j in *.java; do cpp $(CPP_FLAGS) -o $(SRC)/com/qzx/au/$(MOD)/$$j $$j; done)
	@(cd src; for d in *; do if [ -d "$$d" ]; then mkdir $(SRC)/com/qzx/au/$(MOD)/$$d; for j in $$d/*.java; do cpp $(CPP_FLAGS) -o $(SRC)/com/qzx/au/$(MOD)/$$j $$j; done; fi; done)

	@../.only_with.sh $(SRC)/com/qzx/au/$(MOD) $(VER)

ifdef DEBUG
	@(cp ../Debug.java $(SRC)/com/qzx/au/$(MOD)/)
	@(sed -E -i "s:MOD_LOWER:$(MOD):" $(SRC)/com/qzx/au/$(MOD)/Debug.java)
	@(sed -E -i "s:MOD_UPPER:$(MODUPPER):" $(SRC)/com/qzx/au/$(MOD)/Debug.java)
endif

	@(cp _mcmod.info mcmod.info)
	@(sed -E -i "s: modVersion = \"0.0.0\": modVersion = \"$(VER)-$(NOW)\":" $(SRC)/com/qzx/au/$(MOD)/$(AUMOD).java)
	@(sed -E -i "s:\"version\"\: \"0.0.0\":\"version\"\: \"$(VER)-$(NOW)\":" mcmod.info)
	@(sed -E -i "s:\"mcversion\"\: \"0.0.0\":\"mcversion\"\: \"$(DOTVER)\":" mcmod.info)

	@mkdir -p $(MOD_ASSETS)
	@(if [ -d "lang" ]; then cp -R lang $(MOD_ASSETS)/; fi)

clean:
	rm -f au_$(MOD)-*.zip
	rm -rf mcmod.info com mods assets
